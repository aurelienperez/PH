---
title: "INSEE projections"
subtitle: "Exercices de projection 2010-2016-2021"
description: |
  Exercices de projection 2010-2016-2021
author:
  - name: Aurelien Perez
date: "`r Sys.Date()`"
output: 
  rmdformats::readthedown:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: tango
    code_folding: hide
    use_bookdown: true

# bibliography: references.bib 
# csl: advances-in-statistical-climatology-meteorology-and-oceanography.csl
link-citations: true
linkcolor: red
---

Calcul de l'espérance de vie résiduelle à 60 ans chez les femmes à partir des projections de l'INSEE en 2021 et en 2016 selon 3 scénarios pour l'espérance de vie:

-   Espérance de vie basse
-   Espérance de vie centrale
-   Espérance de vie haute

[Tables 2021](https://www.insee.fr/fr/statistiques/5894085?sommaire=5760764)

[Tables 2016](https://www.insee.fr/fr/statistiques/2518406?sommaire=2496793)

[Tables 2010](https://www.insee.fr/fr/statistiques/2517966?sommaire=2020101)

[Calcul quotient mortalité age révolu](https://www.insee.fr/fr/statistiques/6655536?sommaire=6543680#documentation-sommaire)

```{r}
library(readxl)
library(tidyverse)
library(highcharter)
library(webshot2)
```

```{r}
knitr::opts_chunk$set(warning=FALSE)
knitr::opts_chunk$set(message=FALSE)
```

```{r}
#Thème pour tous les graphes
set.seed(123)
palette <- colorRampPalette(c("#541388", "#d90368", "#f1e9da", "#2e294e", "#ffd400"))(10)
mon_theme <- hc_theme_merge(hc_theme_google(),hc_theme(colors=palette))
```

```{r}
espF60 <- read_excel("Classeur1.xlsx")
```

```{r}
espF60 <- espF60 %>% pivot_longer(cols=-Annee,names_to = "scenario",values_to = "Esperance de vie")
```

```{r}
highchart() %>% 
  hc_add_series(espF60,"line",hcaes(x=Annee,y=`Esperance de vie`,group=scenario),marker=list(enabled=FALSE)) %>% 
  hc_title(text="Espérance de vie résiduelle à 60 ans chez les femmes")%>% 
  hc_add_theme(mon_theme)
```

Il y a une correction de 0.5 sur les tables de 2021 qui n'est pas présente dans les tables de 2016. On rajoute cette correction.

```{r}
espF60 <- espF60 %>% mutate(`Esperance de vie` =ifelse(scenario %in% c("2013_B","2013_C","2013_H"), `Esperance de vie` + 0.5,`Esperance de vie`)) 
```

```{r}
highchart() %>% 
  hc_add_series(espF60,"line",hcaes(x=Annee,y=`Esperance de vie`,group=scenario),marker=list(enabled=FALSE))  %>% 
  hc_title(text="Espérance de vie résiduelle à 60 ans chez les femmes (+0.5)")%>% 
  hc_add_theme(mon_theme)
```

On constate que le scénario haut de 2021 coincide avec le scénario central de 2016 et le scénario central de 2021 coincide avec le scénario bas de 2016.

**Definitions:**

Selon l'INSEE,

**L'âge atteint** dans l'année est l'âge qu'une personne atteint au cours d'une année civile donnée. Il correspond à l'âge au 31 décembre de l'année. C'est également la différence entre une année donnée et l'année de naissance.

**L'âge en années révolues** correspond au nombre d'années entières écoulées entre la date de naissance de la personne et la date de référence utilisée.

**Exemple:**

Par exemple, un individu né le 10 octobre 1925 décède le 18 avril 1999. Il a 74 ans en âge atteint dans l'année : 1999 - 1925 = 74. Mais il a 73 ans en années révolues : 18 avril 1999 - 10 octobre 1925 = 73 ans 6 mois et 8 jours.

Ainsi, pour un individu ayant x ans en âge atteint dans l'année, si l'événement a eu lieu à la date d :

-   l'individu ayant son anniversaire après la date d aura comme âge en années révolues (x-1) ;

-   l'individu ayant son anniversaire à la date d ou avant aura comme âge en années révolues (x).

Seule exception : l'événement a lieu le 31 décembre. À cette date, le classement par âge atteint dans l'année et par âge en années révolues sont identiques. Et au 1er janvier, l'âge atteint dans l'année est égal à l'âge en années révolues plus un.

Pour le scénario haut de 2021, j'ai calculé $S_x$ le nombre de survivants à l'age révolu x à partir du quotient de mortalité à l'age atteint x pour 100 000 individus $q_x$ et la proportion de décès avant anniversaire $p_x$.

$$
S_0=100\text{ }000
$$

$$
S_x=S_{x-1}(1-\frac{q_{x-1} \times(1-p_{x-1})+p_{x} \times q_{x}}{100\text{ }000})
$$

$$p_0=0$$

$$
S_x^*=S_{x-1}^*(1-\frac{q_{x-1}}{100\text{ }000})
$$ \* est pour dire que c'est en age atteint.

```{r}
Haut2021F <- read_excel("Classeur1.xlsx", sheet = "Haut2021F", col_names = FALSE)
colnames(Haut2021F) <- c("Age",1962:2070)
```

```{r}
Haut2021F
```

```{r}
Central2021F <- read_excel("Classeur1.xlsx", sheet = "Central2021F", col_names = FALSE)
colnames(Central2021F) <- c("Age",1962:2070)
```

```{r}
Bas2021F <- read_excel("Classeur1.xlsx", sheet = "Bas2021F", col_names = FALSE)
colnames(Bas2021F) <- c("Age",1962:2070)
```

Ci-dessous une fonction qui permet de calculer l'espérance de vie résiduelle à l'age x selon la formule suivante:

$$
e_x=0.5+\frac{\sum_{i=x+1}^{120}S_i}{S_x}
$$

Cette fonction prend l'age x en argument et renvoie un dataframe avec l'espérance de vie résiduelle à l'age x par année calendaire.

```{r}
esp_x <- function(x,data){
  data.frame(Annee=1962:2070,`Esperance de vie`=apply(data %>% select(-Age),2,function(y){sum(y[(x+1):length(y)])/y[x+1]+0.5}),row.names = NULL)
}
esp_x(60,Haut2021F)
```

```{r}
df <- read_excel("Classeur1.xlsx", sheet = "Feuil1", col_names = FALSE)
colnames(df) <- c("Age",1962:2070)
```

$$
e_{xt}=0.5+\sum_{i=1}^{120-x} \prod_{k=0}^{i-1}(1-q_{x+k,t+k})
$$

```{r}
df <- df %>% mutate_all(function(x) x/100000)
df <- df %>% mutate(Age=Age*100000)
```

```{r}
esp_xt <- function(x,t,data){
  q <- data %>% filter(Age>=x) %>% select_if(colnames(data)>=as.character(t)) %>% select(-Age)
  q <- diag(as.matrix(q))
  q <- c(q,data %>% select(Age,"2070") %>% filter(Age>x+2070-t) %>% pull(-Age))
  p <- 1-q
  sum(cumprod(p)[1:(120-x)])+0.5
  }
```

```{r}
esp_xt(65,2022,df)
```

```{r}
vesp <- Vectorize(esp_xt,c("x","t"))
esp_xthautF <- data.frame(Annee=2013:2070,y=vesp(60,2013:2070,df))

```

```{r}
highchart() %>% 
  hc_add_series(esp_xthautF,"line",hcaes(x=Annee,y=y),marker=list(enabled=FALSE))  %>% 
  hc_title(text="Espérance de vie résiduelle à 60 ans chez les femmes (+0.5)")%>% 
  hc_add_theme(mon_theme)
```

## R

A partir de la je ne travaille plus que sur les quotients de mortalité directement sur R.

J'ai rassemblé dans une feuille Excel les quotients de mortalité des scénarios haut, central et bas des exercices 2021, 2016 et 2010.

Et j'ai mis une colonne Table qui indique la table d'où proviennent les quotients de mortalité.

### Qxt

```{r}
qxt <- read_excel("qx.xlsx", sheet = "Feuil1")
colnames(qxt) <- c("Age",1962:2070,"Table")
```

```{r}
qxt <- qxt %>% select(-Age) %>% mutate(across(as.character(1962:2070),~ifelse(grepl("2010",qxt$Table)|grepl("2016",qxt$Table),./10000,./100000))) %>% mutate(Age=qxt$Age,.before = "1962") 
# qxt %>% glimpse 
```

### Sxt

Je définis les $S_{xt}$ en age atteint par:

$$
S_{xt}=S_{x-1,t}(1-q_{x-1,t})
$$

```{r}
# argument q correspond a qx pour une année t fixée
def_S <- function(q){
# Comme on rajoute une ligne 100 000 avant l'age 0, il faut s'assurer que S fasse la bonne taille
S <- numeric(length=length(q)+length(unique(qxt$Table)))
i=1
j=1
while (i<=length(q)+length(unique(qxt$Table))) {
  #il faut aussi s'assurer que 100 000 soit placé au bon endroit
  if (i %in% (seq(1,length(q)+length(unique(qxt$Table)),table(qxt$Table)[1])+0:(length(unique(qxt$Table))))){
    S[i] <- 100000
    i=i+1
  }
  else{
    S[i] <- S[i-1] * (1 - q[j])
    i=i+1
    j=j+1
  }
}
return(S)
}
```

```{r}
Sxt <- data.frame(matrix(NA,ncol=109,nrow=2196))
colnames(Sxt) <- as.character(1962:2070)
for (annee in as.character(1962:2070)){
  Sxt[[annee]] <- def_S(qxt[[annee]])
}
```

```{r}
# On vérifie que la colonne Age est bien le vecteur 0:120 répété 12 fois
unique(rep(0:120,18)==qxt$Age)
```

```{r}
#On rajoute les ages et la table
age <- rep(c(NA,0:120),18)
Table <- rep(unique(qxt$Table),each=122)
Sxt <- Sxt %>% mutate(Age=age,.before="1962") %>% mutate(Table=Table)
```

On fige la mortalité a partir de 2070.

```{r}
for (annee in 2071:2142){
  Sxt[[as.character(annee)]] <- Sxt[["2070"]]
}
```

### Sxg

On définit $S_{xg}^{gen}$ par:

$$
S_{xg}^{gen}=S_{x,g+x}
$$

```{r}
Sg <- data.frame(Age=filter(Sxt,Table=="F2021C")[["Age"]])
for (g in 1962:2022){
  Sg[[as.character(g)]][1] <- 100000
  for (x in 0:120){
    # x+2 a cause du décalage avec la ligne 100 000 dans Sxt
    Sg[[as.character(g)]][x+2] <- filter(Sxt,Table=="F2021C",Age==x)[[as.character(g+x)]]
  }
}
```

```{r}
library(xlsx)

write.xlsx(Sg,                   
           "C:/Users/aper/Documents/Sg.xls",                
           sheetName = "Sheet1", 
           col.names = TRUE,     
           row.names = FALSE,     
           append = FALSE,       
           showNA = FALSE        
           )      
```

```{r}
esp_xg <- function(x,data){
  data.frame(Génération=1962:2022,`Esperance de vie`=apply(data %>% select(-Age),2,function(y){sum(y[(x+2):length(y)])/y[x+2]+0.5}),row.names = NULL)
}
esp_xg(65,Sg)
esp_x(65,Central2021F)
```

### Espérance de vie du moment

```{r}
qxt <- qxt %>% select(-as.character(1962:2021),-as.character(2061:2070))
```

```{r}
esp_mom <- function(age,nom_table){
  q <- qxt %>% filter(Table==nom_table,Age>=age) %>% select(-Table,-Age)
  tibble(x=2022:2060,y=apply(q,2,function(x) {sum(cumprod(1-x))}),table=nom_table)
}

plot_esp_mom <- function(age,nom_tables){
  hc <- highchart() %>% 
    hc_title(text=ifelse(age!=0,paste("Espérance de vie résiduelle à l'âge",age),"Espérance de vie à la naissance")) %>% 
    hc_add_series(esp_mom(age,nom_tables[1]),"line",hcaes(x=x,y=y),name=nom_tables[1],marker=list(enabled=F)) %>% 
    hc_xAxis(title=list(text="Année")) %>% 
    hc_yAxis(title=list(text="Espérance de vie"))
  for (i in 2:length(nom_tables)){
    hc <- hc %>% 
      hc_add_series(esp_mom(age,nom_tables[i]),"line",hcaes(x=x,y=y),name=nom_tables[i],marker=list(enabled=F))
  }
  hc 
}

plot_esp_mom(0,c("F2021C","F2016C","F2021B","F2016B","F2021H","F2016H"))
plot_esp_mom(0,c("H2021C","H2016C","H2021B","H2016B","H2021H","H2016H"))
plot_esp_mom(65,c("F2021C","F2016C","F2021B","F2016B","F2021H","F2016H"))
plot_esp_mom(65,c("H2021C","H2016C","H2021B","H2016B","H2021H","H2016H"))
plot_esp_mom(85,c("F2021C","F2016C","F2021B","F2016B","F2021H","F2016H"))
plot_esp_mom(85,c("H2021C","H2016C","H2021B","H2016B","H2021H","H2016H"))
```

```{r}
listarg <- list(
list(0,c("F2021C","F2016C","F2021B","F2016B","F2021H","F2016H")),
list(0,c("H2021C","H2016C","H2021B","H2016B","H2021H","H2016H")),
list(65,c("F2021C","F2016C","F2021B","F2016B","F2021H","F2016H")),
list(65,c("H2021C","H2016C","H2021B","H2016B","H2021H","H2016H")),
list(85,c("F2021C","F2016C","F2021B","F2016B","F2021H","F2016H")),
list(85,c("H2021C","H2016C","H2021B","H2016B","H2021H","H2016H"))
)

nplots <- 6
names <- paste0("esp_mom_",c("F0","H0","F65","H65","F85","H85"))

for(i in 1:nplots) {
    plot <- plot_esp_mom(listarg[[i]][[1]],listarg[[i]][[2]])
    htmlwidgets::saveWidget(widget = plot, file = "~/plot.html")
    webshot2::webshot(url = "C:/Users/aper/Documents/plot.html", file = paste0(names[i],".png"),delay = 3,vwidth = 1000,
  vheight = 500)

}





```

```{r}
plot_esp_mom(0,c("F2016C","F2010C","F2016B","F2010B","F2016H","F2010H"))
plot_esp_mom(0,c("H2016C","H2010C","H2016B","H2010B","H2016H","H2010H"))
plot_esp_mom(65,c("F2016C","F2010C","F2016B","F2010B","F2016H","F2010H"))
plot_esp_mom(65,c("H2016C","H2010C","H2016B","H2010B","H2016H","H2010H"))
plot_esp_mom(85,c("F2016C","F2010C","F2016B","F2010B","F2016H","F2010H"))
plot_esp_mom(85,c("H2016C","H2010C","H2016B","H2010B","H2016H","H2010H"))
```

```{r}
listarg <- list(
list(0,c("F2016C","F2010C","F2016B","F2010B","F2016H","F2010H")),
list(0,c("H2016C","H2010C","H2016B","H2010B","H2016H","H2010H")),
list(65,c("F2016C","F2010C","F2016B","F2010B","F2016H","F2010H")),
list(65,c("H2016C","H2010C","H2016B","H2010B","H2016H","H2010H")),
list(85,c("F2016C","F2010C","F2016B","F2010B","F2016H","F2010H")),
list(85,c("H2016C","H2010C","H2016B","H2010B","H2016H","H2010H"))
)

nplots <- 6
names <- paste0("esp_mom_",c("F0","H0","F65","H65","F85","H85"),"2")

for(i in 1:nplots) {
    plot <- plot_esp_mom(listarg[[i]][[1]],listarg[[i]][[2]])
    htmlwidgets::saveWidget(widget = plot, file = "~/plot.html")
    webshot2::webshot(url = "C:/Users/aper/Documents/plot.html", file = paste0(names[i],".png"),delay = 3,vwidth = 1000,
  vheight = 500)

}

```

### Espérance de vie par génération

Calcul de l'espérance de vie:

$$
e_x=\sum_{t=1}^{120-x} \text{ }_tp_x
$$

2 formules

-   Comme $\text{ }_tp_x = \prod_{s=0}^{t-1} p_{x+s}$, on a:

$$
e_x = \sum_{t=1}^{120-x} \prod_{s=0}^{t-1} p_{x+s} = \sum_{t=1}^{120-x} \prod_{s=0}^{t-1}(1-q_{x+s})=(1-q_x)+(1-q_x)(1-q_{x+1})+\cdots
$$

-   Comme $\text{ }_tp_x=\frac{l_{x+t}}{l_x}$ , on a:

$$
e_x=\sum_{t=1}^{120-x}\frac{l_{x+t}}{l_x}=\frac{1}{l_x}\sum_{t=1}^{120-x}l_{x+t}=\frac{1}{l_x}\sum_{k=x+1}^{120}l_k
$$

pour l'espérance de vie résiduelle à l'age x par génération, on considère les quotients de mortalités sur la diagonale de la génération concernée:

$$
e_{xt}=\sum_{i=1}^{120-x} \prod_{k=0}^{i-1}(1-q_{x+k,t+k})
$$

```{r}
esp_xt <- function(x,t,data){
  q <- data  %>% filter(Age>=x) %>% select_if(colnames(data)>=as.character(t)) %>% select(-Age,-Table)
  q <- diag(as.matrix(q))
  
  #on fige la mortalité a partir de 2070
  # if (grepl("2010",data$Table[1])){
    q <- c(na.omit(q),data %>% select(Age,"2060") %>% filter(Age>x+2060-t) %>% pull(-Age))
  # }
  # else{
  # q <- c(q,data %>% select(Age,"2070") %>% filter(Age>x+2070-t) %>% pull(-Age))
  # }

  p <- 1-q
  # sum(cumprod(p)[1:(120-x)])+0.5
  sum(cumprod(p)[1:(120-x)])
}
vesp <- Vectorize(esp_xt,c("x","t"))
# vesp(65,2022:2070,qxt %>% filter(Table=="F2021C"))
# vesp(60,2022:2070,qxt %>% filter(Table=="F2010C"))
```

```{r}
trace <- function(nom_table,L){
  highchart() %>% 
  # hc_add_series(esp_xg(L,Sg),"line",hcaes(x=`Génération`,y=`Esperance.de.vie`)) %>%
  # hc_add_series(esp_x(L,Central2021F) %>% filter(Annee<=2022),"line",hcaes(x=`Annee`,y=`Esperance.de.vie`)) %>%
  hc_add_series(tibble(x=2022:2060-L,y=vesp(L,2022:2060,qxt %>% filter(Table==nom_table))),"line",hcaes(x=x,y=y),name=nom_table,marker=list(enabled=F))%>% 
    hc_title(text=ifelse(L==0,"Espérance de vie à la naissance",paste0(paste0("Espérance de vie résiduelle à ",L)," ans"))) %>% 
    hc_yAxis(title=list(text="Espérance de vie résiduelle")) %>% 
    hc_xAxis(title=list(text="Génération"))
}

add <- function(hc,nom_table,L){
  hc %>% 
    hc_add_series(tibble(x=2022:2060-L,y=vesp(L,2022:2060,qxt %>% filter(Table==nom_table))),"line",hcaes(x=x,y=y),name=nom_table,marker=list(enabled=F))%>% 
    hc_title(text=ifelse(L==0,"Espérance de vie à la naissance",paste0(paste0("Espérance de vie résiduelle à ",L)," ans"))) %>% 
    hc_yAxis(title=list(text="Espérance de vie résiduelle")) %>% 
    hc_xAxis(title=list(text="Génération")) %>% 
    hc_tooltip(shared = TRUE)
}

compare_exercice <- function(L,Sexe,Scenario){
  trace(nom_table  = paste0(Sexe,"2021",Scenario),L=L) %>% add(nom_table  = paste0(Sexe,"2016",Scenario),L=L) %>% add(nom_table  = paste0(Sexe,"2010",Scenario),L=L) %>% hc_subtitle(text=ifelse(Sexe=="F","Femme","Homme"))
}
```

```{r}
L <- 65
trace(nom_table = "F2016C",L=L)
```

### Qxt age révolu

![](images/Capture%20d%E2%80%99%C3%A9cran%202023-06-07%20161718.png)

```{r}
#argument S correspond au dataframe S, p1 proportion de décès à l’âge atteint x pendant l’année t ayant eu lieu avant l’âge révolu x, p2 proportion de décès à l’âge atteint x+1 pendant l’année t+1 ayant eu lieu avant l’âge révolu x+1
def_qxt_rev <- function(S,annee,p1,p2){
  S <- S[c(annee,as.character(as.numeric(annee)+1))]
  
q <- numeric(length=dim(S)[1])
for (i in 1:dim(S)[1]) {
  SA <- S[i,1]
  SB <- S[i+1,1]
  SC <- S[i+1,2]
  SD <- S[i+2,2]
  q[i] <- 1 - SB/(SA-p1[i]*(SB-SA))*(SC-p2[i]*(SC-SD))/SC
} 
return(q)
}
```

```{r}
p1 <-
  c(
    0.000000000000,
    0.740101522843,
    0.629427792916,
    0.509505703422,
    0.553191489362,
    0.538888888889,
    0.464285714286,
    0.496183206107,
    0.474137931034,
    0.444444444444,
    0.526315789474,
    0.526315789474,
    0.500000000000,
    0.487012987013,
    0.511764705882,
    0.464601769912,
    0.515384615385,
    0.529411764706,
    0.389776357827,
    0.569060773481,
    0.513513513514,
    0.489156626506,
    0.496103896104,
    0.503856041131,
    0.524940617577,
    0.443661971831,
    0.488262910798,
    0.474945533769,
    0.497991967871,
    0.490848585691,
    0.533742331288,
    0.480127186010,
    0.502754820937,
    0.481879194631,
    0.490453460621,
    0.507150715072,
    0.488416988417,
    0.457216940363,
    0.488391376451,
    0.486306439674,
    0.471539002108,
    0.480731548008,
    0.489988876529,
    0.459048553212,
    0.481450948063,
    0.468411214953,
    0.477137176938,
    0.472910927456,
    0.482362373063,
    0.477267018337,
    0.479972054029,
    0.482530120482,
    0.490017445241,
    0.487211367673,
    0.488483053636,
    0.482962289868,
    0.484693877551,
    0.488256134366,
    0.496946005375,
    0.479104818452,
    0.482579688658,
    0.483977568596,
    0.478747846065,
    0.479854809437,
    0.483097988875,
    0.479178190439,
    0.479672375279,
    0.478119015533,
    0.484715284715,
    0.484924623116,
    0.486158745713,
    0.481291799723,
    0.483529551671,
    0.486739284869,
    0.485563660884,
    0.481435363369,
    0.481975754998,
    0.478764665956,
    0.482761619060,
    0.480706344016,
    0.477014566350,
    0.475197444316,
    0.482555360841,
    0.480255859513,
    0.483483042310,
   0.486329184991,
   0.486482300504,
   0.490248939759,
    0.495835258005,
   0.496259921201,
    0.501631456697,
    0.507813145928,
    0.515991740761,
    0.512352137646,
    0.519553503883,
    0.527367448114,
    0.537299221725,
    0.552510550806,
    0.557417064241,
    0.569179415855,
    0.557379838367,
    0.550373723550,
    0.554029432376,
    0.565225323846,
    0.569792221630,
    0.610011641444,
    0.597693351425,
    0.606622516556,
    0.625310173697,
    0.607296137339,
    0.607296137339,
    0.607296137339,
    0.607296137339,
    0.607296137339,
    0.607296137339,
    0.607296137339,
    0.607296137339,
    0.607296137339,
    0.607296137339,
    0.607296137339,
    0.607296137339
  )
p2 <- lead(p1)
qxt_rev <- data.frame(matrix(NA,ncol=108,nrow=2196))
colnames(qxt_rev) <- as.character(1962:2069)
for (annee in as.character(1962:2069)){
  qxt_rev[[annee]] <- def_qxt_rev(Sxt,annee,p1,p2)
}
```

```{r}
qxt_rev <- qxt_rev %>% mutate(Age=age,.before="1962") %>% mutate(Table=Table)
```

## Comparaison exercices 2010/2016/2021

```{r}
#scénario central
Ls <- c(0,65,75,85,95)
for (L in Ls){
print(
  
compare_exercice(L,"F","C")

)
}
```

\

```{r}
listarg <- list(
list(65,"F"),
list(65,"H"),
list(85,"F"),
list(85,"H")
)

nplots <- 4
names <- paste0("esp_gen_",c("F65","H65","F85","H85"))

for(i in 1:nplots) {
    plot <- compare_exercice(listarg[[i]][[1]],listarg[[i]][[2]],"C")
    htmlwidgets::saveWidget(widget = plot, file = "~/plot.html")
    webshot2::webshot(url = "C:/Users/aper/Documents/plot.html", file = paste0(names[i],".png"),delay = 3,vwidth = 1000,
  vheight = 500)

}

```

```{r}
#scénario central
Ls <- c(0,65,75,85,95)
for (L in Ls){
print(
  
compare_exercice(L,"H","C")

)
}
```

```{r}
#scénario bas
Ls <- c(0,65,75,85,95)
for (L in Ls){
print(
  
compare_exercice(L,"H","B")

)
}
```

```{r}
#scénario haut
Ls <- c(0,65,75,85,95)
for (L in Ls){
print(
  
compare_exercice(L,"H","H")

)
}
```

\

```{r}
qx_level <- function(nom_table){
  
  nbcol <- 30
  breakpoints <- seq(0, 0.6, length.out = nbcol+1)
  colormap <- colorRampPalette(c("white", "blue"))(nbcol)
  
  
  
  
  qxt %>% filter(Table==nom_table) %>% select(-as.character(2060:2070)) %>% select(-Table,-Age) %>% as.matrix() %>% t() %>% lattice::levelplot(col.regions = colormap, xlab = "Année de naissance", ylab = "Age", at = breakpoints,scales=list(x=list(at=seq(1,38,by=15))))
}

qx_level("F2010C")
qx_level("F2016C")
qx_level("F2021C")

```

## Evolution qx par an

```{r}
qxt <- qxt %>% select(-as.character(1962:2021))
```

\

```{r}
def_qxg <- function(nom_table,gmin=1920,gmax=2022,amin=0,amax=120){
  qxg <- matrix(numeric(0),nrow=amax-amin+1,ncol=gmax-gmin+1)
  qxg <- data.frame(qxg)
  colnames(qxg) <- as.character(gmin:gmax)
  qxg <- qxg %>% mutate(Age=filter(qxt,Table==nom_table)[["Age"]],.before=as.character(gmin))
qxt_filtre <- filter(qxt, Table == nom_table)
  for (g in gmin:gmax){
    for (x in amin:amax){
      aj <- filter(qxt_filtre, Age == x)[[as.character(g + x)]]
      qxg[[as.character(g)]][x + 1] <-

        ifelse(
          is.null(aj)
               , NA
          , aj
          )
    }
  }
  return(qxg)
}



```

```{r}
for (t in unique(qxt$Table)){
  nam <- paste("qxg",t,sep="_")
  assign(nam,def_qxg(t))
}
```

\

```{r}
lev_plot_mom <- function(nom_table,gmin=2022,gmax=2060,amin=0,amax=120){
    qxt_filtre <- qxt %>% filter(Table==nom_table) %>% select(-Table)
  
    Ta1 <- qxt_filtre %>% filter(amin<Age,Age<amax) %>% select(-Age) %>% select(as.character((gmin+1):gmax))
    Ta2 <- qxt_filtre %>% filter(amin<Age,Age<amax) %>% select(-Age) %>% select(as.character((gmin+1):gmax-1))
  aaa <-   (as.matrix(Ta1)-as.matrix(Ta2))/as.matrix(Ta2)
    
    nbcol <- 30
  breakpoints <- seq(-0.05, 0.05, length.out = nbcol+1)
  colormap <- colorRampPalette(c("blue", "white", "#A00000"))(nbcol)
  
  
  
  lattice::levelplot(t(aaa), col.regions = colormap, xlab = "Année", ylab = "Age", at = breakpoints,scales=list(x=list(at=seq(1,38,by=15))),main=paste("Table des",ifelse(substring(nom_table,1,1)=="H",'hommes',"femmes"),"/ Exercice",substring(nom_table,2,5)))
}


```

\

```{r}

lev_plot_gen <- function(nom_table,gmin=1920,gmax=2022,amin=0,amax=120){
    qxg <- get(paste("qxg",nom_table,sep="_"))
  
    Ta1 <- qxg %>% filter(amin<Age,Age<amax) %>% select(-Age) %>% select(as.character((gmin+1):gmax))
    Ta2 <- qxg %>% filter(amin<Age,Age<amax) %>% select(-Age) %>% select(as.character((gmin+1):gmax-1))
  aaa <-   (as.matrix(Ta1)-as.matrix(Ta2))/as.matrix(Ta2)
    
    nbcol <- 30
  breakpoints <- seq(-0.05, 0.05, length.out = nbcol+1)
  colormap <- colorRampPalette(c("blue", "white", "#A00000"))(nbcol)
  
  
  
  lattice::levelplot(t(aaa), col.regions = colormap, xlab = "Année de naissance", ylab = "Age", at = breakpoints,scales=list(x=list(at=seq(1,100,by=19))),main=paste("Table des",ifelse(substring(nom_table,1,1)=="H",'hommes',"femmes"),"/ Exercice",substring(nom_table,2,5)))
}





```

```{r}
library(gridExtra)
# grid.arrange(
# lev_plot_mom("F2021C"),
# lev_plot_mom("F2016C"),
# lev_plot_mom("F2010C"),
# lev_plot_mom("H2021C"),
# lev_plot_mom("H2016C"),
# lev_plot_mom("H2010C"),
# lev_plot_gen("F2021C"),
# lev_plot_gen("F2016C"),
# lev_plot_gen("F2010C"),
# lev_plot_gen("H2021C"),
# lev_plot_gen("H2016C"),
# lev_plot_gen("H2010C")
# ,nrow=4)
```

```{r}
lev_plot_mom("F2021C")
lev_plot_mom("F2016C")
lev_plot_mom("F2010C")
lev_plot_mom("H2021C")
lev_plot_mom("H2016C")
lev_plot_mom("H2010C")


```

\

```{r}
trace_desc_mom <- function(nom_table,age,gmin=2022,gmax=2060,amin=0,amax=120){
  qxt_filtre <- qxt %>% filter(Table==nom_table) %>% select(-Table)
  highchart() %>% 
  hc_add_series(tibble(x=gmin:gmax,y=as.matrix(qxt_filtre %>% filter(Age==age) %>% select(as.character(gmin:gmax)))[1,]),"line",hcaes(x=x,y=y),name=paste("Exercice",substring(nom_table,2,5))) %>%
    hc_xAxis(title=list(text="Année")) %>% 
    hc_yAxis(title=list(text=paste0("q",age))) %>% 
    hc_tooltip(shared = TRUE) %>% hc_title(text=paste0("Quotients de mortalité pour l'age ",age)) %>% 
    hc_subtitle(text=paste(ifelse(substring(nom_table,1,1)=="F","Femme |","Homme |")," Scénario",ifelse(substring(nom_table,6)=="C","central",ifelse(substring(nom_table,6)=="H","Haut","Bas"))))%>% 
  hc_add_theme(mon_theme)
}




```

```{r}
trace_desc_mom("F2016C",100) 
```

```{r}
trace_desc_mom("F2016C",90)
```

```{r}
trace_desc_mom("F2021C",90)
```

```{r}
  gmin=2022
  gmax=2060
  amin=0
  amax=120
  qxt_filtre <- qxt %>% filter(Table=="F2010C",Age<=13,Age>=3) %>% select(-Table)
  qxt_filtre <- qxt_filtre %>% pivot_longer(cols=-Age,names_to = "Annee",values_to = "qx")
  highchart() %>% 
  hc_add_series(qxt_filtre,"line",hcaes(x=as.numeric(Annee),y=qx,group=as.factor(Age)),marker=list(enabled=FALSE)) %>%
    hc_xAxis(title=list(text="Année")) %>% 
    hc_yAxis(title=list(text="qx")) %>% 
    hc_tooltip(shared = TRUE) %>% 
    hc_title(text="Quotients de mortalité des femmes | Exercice 2010") %>% 
    hc_subtitle(text="Entre 3 et 13 ans")
```

\

```{r}
lev_plot_gen("F2021C")
lev_plot_gen("F2016C")
lev_plot_gen("F2010C")
lev_plot_gen("H2021C")
lev_plot_gen("H2016C")
lev_plot_gen("H2010C")

```

Pour un age donnée, on observe le taux de décroissance des quotients de mortalité par année de naissance.

```{r}
trace_desc_gen <- function(nom_table,age,gmin=2022,gmax=2060,amin=0,amax=120){
  qxg <- get(paste("qxg",nom_table,sep="_"))
  highchart() %>% 
  hc_add_series(tibble(x=gmin:gmax-age,y=as.matrix(qxg %>% filter(Age==age) %>% select(as.character(gmin:gmax-age)))[1,]),"line",hcaes(x=x,y=y),name=paste("Exercice",substring(nom_table,2,5))) %>%
    hc_xAxis(title=list(text="Année de naissance")) %>% 
    hc_yAxis(title=list(text=paste0("q",age))) %>% 
    hc_tooltip(shared = TRUE) %>% hc_title(text=paste0("Quotients de mortalité pour l'age ",age)) %>% 
    hc_subtitle(text=paste(ifelse(substring(nom_table,1,1)=="F","Femme |","Homme |")," Scénario",ifelse(substring(nom_table,6)=="C","central",ifelse(substring(nom_table,6)=="H","Haut","Bas"))))%>% 
  hc_add_theme(mon_theme)
}

trace_desc_gen("H2016C",90)
```

```{r}
  gmin=2022
  gmax=2060
  amin=0
  amax=120
  qxg_pivot <- qxg_F2016C %>% filter(Age<=92,Age>=90) %>% select(-as.character(c(1920:1930,1990:2022)))
  qxg_pivot <- qxg_pivot %>% pivot_longer(cols=-Age,names_to = "Annee",values_to = "qx")
  highchart() %>% 
  hc_add_series(qxg_pivot,"line",hcaes(x=as.numeric(Annee),y=qx,group=as.factor(Age)),marker=list(enabled=FALSE)) %>%
    hc_xAxis(title=list(text="Année")) %>% 
    hc_yAxis(title=list(text="qx")) %>% 
    hc_tooltip(shared = TRUE) %>% 
    hc_title(text="Quotients de mortalité des femmes | Exercice 2016") %>% 
    hc_subtitle(text="Entre 90 et 91 ans")%>% 
  hc_add_theme(mon_theme)
```

## Differences qx entre tables

```{r}
comp_plot_mom <- function(T1,T2,gmin=2022,gmax=2060,amin=0,amax=120,int=3,nbcol=30){
    qxt_1 <- qxt %>% filter(Table==T1) %>% select(-Table)
    qxt_2 <- qxt %>% filter(Table==T2) %>% select(-Table)
  
    Ta1 <- qxt_1 %>% filter(amin<Age,Age<amax) %>% select(-Age) %>% select(as.character((gmin):gmax))
    Ta2 <- qxt_2 %>% filter(amin<Age,Age<amax) %>% select(-Age) %>% select(as.character((gmin):gmax))
  aaa <-   (as.matrix(Ta1)-as.matrix(Ta2))/as.matrix(Ta2)
    

  breakpoints <- seq(-int, int, length.out = nbcol+1)
  colormap <- colorRampPalette(c("blue", "white", "#A00000"))(nbcol)
  
  
  
  lattice::levelplot(t(aaa), col.regions = colormap, xlab = "Année", ylab = "Age", at = breakpoints,scales=list(x=list(at=seq(1,38,by=15))),main=paste("Table des",ifelse(substring(T1,1,1)=="H",'hommes',"femmes"),"/ Exercice",substring(T1,2,5),"-",substring(T2,2,5)))
}


```

```{r}
comp_plot_gen <- function(T1,T2,gmin=1920,gmax=2022,amin=0,amax=120,int=3,nbcol=30){
    qxg_1 <- get(paste("qxg",T1,sep="_"))
    qxg_2 <- get(paste("qxg",T2,sep="_"))
  
    Ta1 <- qxg_1 %>% filter(amin<Age,Age<amax) %>% select(-Age) %>% select(as.character((gmin):gmax))
    Ta2 <- qxg_2 %>% filter(amin<Age,Age<amax) %>% select(-Age) %>% select(as.character((gmin):gmax))
  aaa <-   (as.matrix(Ta1)-as.matrix(Ta2))/as.matrix(Ta2)
    

  breakpoints <- seq(-int, int, length.out = nbcol+1)
  colormap <- colorRampPalette(c("blue", "white", "#A00000"))(nbcol)
  
  
  
  lattice::levelplot(t(aaa), col.regions = colormap, xlab = "Année de naissance", ylab = "Age", at = breakpoints,scales=list(x=list(at=seq(1,100,by=19))),main=paste("Table des",ifelse(substring(T1,1,1)=="H",'hommes',"femmes"),"/ Exercice",substring(T1,2,5),"-",substring(T2,2,5)))
}


```

```{r}
comp_plot_mom("F2021C","F2016C")
comp_plot_mom("F2016C","F2010C")
comp_plot_mom("H2021C","H2016C")
comp_plot_mom("H2016C","H2010C")
comp_plot_gen("F2021C","F2016C")
comp_plot_gen("F2016C","F2010C")
comp_plot_gen("H2021C","H2016C")
comp_plot_gen("H2016C","H2010C")
```

### Ajustement loi phase-type table femme exercice 2021

```{r,warning=FALSE,message=FALSE}
source("C:/Users/aper/Documents/PH.R")
```

Il faut récupérer les données sous forme de durées de vie à la naissance. Cela revient à recupérer des nombres de décès par age. On prend un radix de 100 000 et on définit les lx par récurrence.

```{r}
quotients <- qxt %>% filter(Table=="F2021H") %>% select(-Table)
lx_rec <- function(qx){
  l <- vector("list",length(qx))
  l[[1]] <- 100000
  for (i in 1:(length(qx)-1)){
    l[[i+1]] <- l[[i]]*(1-qx[i])
  }
  return(l %>% unlist)
}
lx <- quotients %>% select(-Age) %>% apply(2,FUN =lx_rec) %>% as_tibble %>% mutate(Age=0:120,.before = "2022")
```

```{r}
dx <-  (lx-lead(lx)) %>%  mutate(Age=0:120) 
dat <- lx %>% pivot_longer(cols=c(-Age),names_to = "Annee",values_to = "lx")
dat <- dat %>% left_join(dx %>% pivot_longer(cols=c(-Age),names_to = "Annee",values_to = "dx"),by=c("Age","Annee"))
dat <- dat %>% mutate(Annee=as.numeric(Annee))
dat <- na.omit(dat)
```

On prend l'année 2022 pour voir.

```{r}
xmax <- 110
donnees_ajust <- dat %>% filter(Annee==2022,Age<=xmax)
donnees_ajust <- donnees_ajust %>% mutate(mux=-log(1-dx/lx))
```

```{r}
plot(donnees_ajust$Age,donnees_ajust$dx)
```

On divise les données par un certain nombre "scale" afin d'éviter des problèmes de conditionnement de matrice qui empêchent de faire tourner l'algorithme ou le ralentissent fortement. Néanmoins, plus scale est haut et plus la qualité de l'ajustement est dégradée. Reste à savoir pourquoi tout ceci arrive.

On a donc 3 hyperparamètres: le nombre de phases, le paramètre scale et le nombre d'itérations de l'algorithme EM.

J'ai remarqué que pour avoir un ajustement visuellement satisfaisant, il vaut mieux faire peu d'itérations de l'algorithme EM pour ne pas s'enfermer dans un maximum local de vraisemblance. La minimisation de la fonction de cout fait bien le travail après.

```{r}
m <- 5
set.seed(1)
weights <- (donnees_ajust %>% pull(dx))/100000
y <- (donnees_ajust %>% pull(Age)) + 0.5
n <- 5
x1 <- IPH(PH(structure = "coxienne généralisée" , dimension = m),gfun="gompertz",gfunpars = c(beta=1))
x1@fit <- list(weights=weights,obs=y)
x_fit1 <- fit(x1, y, weight=weights, stepsEM = 1000,every=1,scale=100)


```

\

```{r}
plot(x_fit1)
plot(x_fit1,type="haz",f="log",hch=highchart() %>% 
  hc_add_series(donnees_ajust,"scatter",hcaes(x=Age+0.5,y=log(mux)),name="Observé")
) 
```

```{r}
# loss <- function(x,beta){
#   alpha <- x[1:m]
#   # beta <- abs(x[(m+1)])
#   if (m==1){
#     # S <- matrix(x[m+2])
#     S <- matrix(x[m+1])
#   }
#   else{
#   # S <- diag(x[seq(m+2,2*m+1,1)])
#   # S[cbind(1:(nrow(S)-1), 2:ncol(S))] <- x[(2*m+2):length(x)]
#   S <- diag(x[seq(m+1,2*m,1)])
#   S[cbind(1:(nrow(S)-1), 2:ncol(S))] <- x[(2*m+1):length(x)]
#   }
#   objiph <- IPH(PH(alpha,S),gfun="gompertz",gfunpars = beta)
#   
#   if (all(exit(S)>=0) & abs(sum(alpha)-1)<0.0001 & beta>0 & all((c(S)>=0)==c(diag(-1,m)>=0))){
#     donnees_ajust %>% group_by(Age) %>% filter(mux!= Inf) %>% summarise(A=((log(haz(objiph,Age+0.5))-log(mux))^2)) %>% pull(A) %>%  sum
# 
#   }
#   else{
#   Inf
#   }
#   
# }
# 
# alpha <- x_fit1@pars$alpha
# beta <- x_fit1@gfun$pars
# S <- x_fit1@pars$S
# if (length(alpha)>1){
#   loss(c(alpha,diag(S),S[cbind(1:(nrow(S)-1), 2:ncol(S))]),beta)
# }else {
#   loss(c(alpha,S),beta)
# }
```

```{r}
loss <- function(x,dimension){
  
  beta <- tail(x,1)
  if (dimension==1){
    alpha <- 1
    S <- matrix(x[dimension])
  }
  else{
    alpha <- c(x[1:(dimension-1)],1-sum(x[1:(dimension-1)]))
    S <- diag(x[seq(dimension,2*dimension-1,1)])
    S[cbind(1:(nrow(S)-1), 2:ncol(S))] <- x[(2*dimension):(length(x)-1)]
  }
  objiph <- IPH(PH(alpha,S),gfun="gompertz",gfunpars = beta)

  

  
   L <- donnees_ajust %>% group_by(Age) %>% filter(mux!= Inf) %>% summarise(A=(log(haz(objiph,Age+0.5))-log(mux))^2) %>% pull(A) %>%  sum
   
  cat("\r",format(Sys.time(),'%H:%M:%S'))
  cat(" Fonction de coût : ",L)
  flush.console()
  
   
  return(L)
}

alpha <- x_fit1@pars$alpha[1:(m-1)]
beta <- x_fit1@gfun$pars
S <- x_fit1@pars$S
if (m>1){
  loss(c(alpha,diag(S),S[cbind(1:(nrow(S)-1), 2:ncol(S))],beta),m)
}else {
  loss(c(S,beta),m)
}
```

```{r}
tdim <- 3*m-1
nbeq <- 3*m
if (m>1){
A0 <- matrix(c(rep(-1,m-1),rep(0,tdim-(m-1))),nrow=1)
A1 <- diag(-1,nrow=m-1,ncol=tdim)
A2 <- cbind(matrix(0,nrow=m-1,ncol=m-1),diag(-1,m-1,m),diag(-1,m-1),matrix(0,nrow=m-1,ncol=1))
A3 <- cbind(matrix(0,nrow=m,ncol=m-1),diag(-1,m),matrix(0,nrow=m,ncol=m-1),matrix(0,nrow=m,ncol=1))
A4 <- matrix(c(rep(0,tdim-1),1),nrow=1)
ui <- rbind(A0,-A1,A2,A3,A4)
ci <- c(-1,rep(0,m-1),rep(0,m-1),rep(0,m),0)
theta <- c(alpha,diag(S),ifelse(exit(S)[-m]==0,S[cbind(1:(nrow(S)-1), 2:ncol(S))]-1e-10,S[cbind(1:(nrow(S)-1), 2:ncol(S))]),beta)
oppar <- constrOptim(theta=theta,f=loss,ui=ui,ci=ci,grad=NULL,control = list(maxit=1000),dimension=m)}else{
  theta <- c(S,beta)
  ui <- matrix(c(-1,0,0,1),byrow = T,ncol=2)
  ci <- c(0,0)
  oppar <- constrOptim(theta=theta,f=loss2,ui=ui,ci=ci,grad=NULL,control = list(maxit=5000),dimension=m)
}
oppar
```

```{r}
# if (length(alpha)>1){
#   
# oppar <- optim(par = c(alpha,diag(S),S[cbind(1:(nrow(S)-1), 2:ncol(S))]),loss,control = list(maxit=5000,reltol=1e-8),beta=beta)
# } else{
#   oppar <- optim(par = c(alpha,S),loss,control = list(maxit=5000,reltol=1e-8),beta=beta)
#   }
# oppar$value
```

```{r}
retpar <- function(x,m){
      beta <- tail(x,1)
     if (m==1){
    S <- matrix(x[1])
    alpha <- 1
  }
  else{
  alpha <- x[1:(m-1)]
  alpha <- c(alpha,1-sum(alpha))
  S <- diag(x[seq(m,2*m-1,1)])
  S[cbind(1:(nrow(S)-1), 2:ncol(S))] <- x[(2*m):(length(x)-1)]
  }
    return(list(alpha=alpha,beta=beta,S=S))
}

parlist <- retpar(oppar$par,m)
```

```{r}
x10 <- IPH(PH(alpha = parlist$alpha,S=parlist$S),gfun="gompertz",gfunpars = parlist$beta)

x10@fit$obs <- y

plot(x10,type="haz",f="log",hch=highchart() %>% hc_add_series(donnees_ajust,"scatter",hcaes(x=Age+0.5,y=log(mux)),name="Observé"))  
  
```

```{r}
m <- 3
x20 <- IPH(PH(alpha=c(0.75,0.25,0),S=matrix(c(-0.643,0.641,0,0,-1.757e-5,0,0,0,0),ncol=3,nrow=3,byrow = T)),gfun="gompertz",gfunpars =0.09270214 )

plot(y,donnees_ajust$mux %>% log)
curve(log(haz(x20,x)),col='red',add=T)

alpha <- c(0.75,0.25)
S <- matrix(c(-0.643,0.641,0,0,-1.757e-5,0,0,0,0),ncol=3,nrow=3,byrow = T)
beta <- 0.09270214
loss2(c(alpha,diag(S),S[cbind(1:(nrow(S)-1), 2:ncol(S))],beta))
```

\

```{r}
# library(matrixdist)
# m <- 20
# set.seed(1)
# # x1 <- iph(ph(structure = "gcoxian" , dimension = m),gfun="gompertz")
# x1 <- IPH(PH(structure = "coxienne généralisée" , dimension = m),gfun="gompertz")
# x1 <- iph(ph(alpha = x1@pars$alpha,S=x1@pars$S),gfun="gompertz")
# weights <- (donnees_ajust %>% pull(dx))/100000
# y <- (donnees_ajust %>% pull(Age)) + 0.5
# set.seed(1)
# x_fit <- fit(x1, y/100, weight=weights, stepsEM = 1000,every=10,methods=c("PADE","PADE"))
# # l1 <- 5
# # l2 <- 20
# # l <- vector("list",100)
# # i=1
# # while((l2-l1)/l1>0.01/100){
# #   l1 <- logLik(x_fit1)
# #   l[i] <- l1
# #   i=i+1
# #   if (i%%5==0){
# #     l %>% unlist %>% plot()
# #   }
# #   x_fit1 <- fit(x_fit1, y/100, weight=weights, stepsEM = 10,every=1)
# #   l2 <- logLik(x_fit1)
# # }
```

```{r}
# x_fit2 <- x_fit
# x_fit2@pars$S <- coef(x_fit2)$S/100
# x_fit2@gfun$pars <- x_fit2@gfun$pars/100
# plot(donnees_ajust$Age,donnees_ajust$dx/100000)
# curve(dens(x_fit2,x),col='red',add=T,xlim=c(0.1,110))
```

```{r}
# donnees_ajust <- donnees_ajust %>% mutate(mux=-log(1-dx/lx))
# plot(y,log(donnees_ajust$mux))
# curve(log(haz(x_fit2,x)),add=T,col='red')
```

```{r}
# df <- tibble(Age=y,obs=log(donnees_ajust$dx/donnees_ajust$lx))
# 
# highchart() %>% 
#   hc_add_series(df,"scatter",hcaes(x=Age,y=obs)) %>% 
#     hc_xAxis(title=list(text="Age")) %>% 
#   hc_title(text="Logarithme des quotients de mortalité") %>%
#   hc_subtitle(text="Table instantanée 2022 des femmes | Exercice de projection 2021") %>% 
#   hc_legend(enabled=F) %>% 
#   hc_tooltip(shared=T)
```

```{r}
# loss <- function(x){
#   alpha <- x[1:m]
#   beta <- abs(x[(m+1)])
#   S <- diag(x[seq(m+2,2*m+1,1)])
#   S[cbind(1:(nrow(S)-1), 2:ncol(S))] <- x[(2*m+2):length(x)]
#   IPH <- iph(ph(alpha,S),gfun="gompertz",gfun_pars = beta)
#   
#   if (all(apply(S,1,function(x) -sum(x))>=0) & abs(sum(alpha)-1)<0.0001 & all((c(S)>=0)==c(diag(-1,m)>=0))){
#     donnees_ajust %>% group_by(Age) %>% filter(mux!= Inf) %>% summarise(A=((log(haz(IPH,Age+0.5))-log(mux))^2)) %>% pull(A) %>%  sum
# 
#   }
#   else{
#     Inf
#   }
#   
# }
# 
# alpha <- x_fit2@pars$alpha
# beta <- x_fit2@gfun$pars
# S <- x_fit2@pars$S
# loss(c(alpha,beta,diag(S),S[cbind(1:(nrow(S)-1), 2:ncol(S))]))
```

```{r}
# oppar <- optim(par = c(alpha,beta,diag(S),S[cbind(1:(nrow(S)-1), 2:ncol(S))]),loss,control = list(maxit=5000,reltol=1e-8))
# oppar$value
```

```{r}
# retpar <- function(x){
#       alpha <- x[1:m]
#       beta <- abs(x[(m+1)])
#       S <- diag(x[seq(m+2,2*m+1,1)])
#       S[cbind(1:(nrow(S)-1), 2:ncol(S))] <- x[(2*m+2):length(x)]
#     return(list(alpha=alpha,beta=beta,S=S))
# }
# 
# parlist <- retpar(oppar$par)
```

```{r}
# x10 <- iph(ph(alpha = parlist$alpha,S=parlist$S),gfun="gompertz",gfun_pars = parlist$beta)
```

```{r}
# df <- tibble(Age=y,obs=log(donnees_ajust$mux),aj=log(haz(x10,y)))
# 
# highchart() %>% 
#   hc_add_series(df,"scatter",hcaes(x=Age,y=obs),name="Observé") %>% 
#   hc_add_series(df,"line",hcaes(x=Age,y=aj),name="Ajusté") %>%
#     hc_xAxis(title=list(text="Age")) %>% 
#   hc_title(text="Fonction de hasard") %>%
#   hc_subtitle(text="Ajustement d'une loi IPH-Gompertz de dimension 17 | Structure coxienne généralisée | Après minimisation du carré de la somme du log-ratio des fonctions de hasard") %>% 
#   hc_tooltip(shared=T)
```

```{r}
# df <- tibble(Age=y,obs=(donnees_ajust$mux),aj=(haz(x10,y)))
# 
# highchart() %>% 
#   hc_add_series(df,"scatter",hcaes(x=Age,y=obs),name="Observé") %>% 
#   hc_add_series(df,"line",hcaes(x=Age,y=aj),name="Ajusté") %>%
#     hc_xAxis(title=list(text="Age")) %>% 
#   hc_title(text="Fonction de hasard") %>%
#   hc_subtitle(text="Ajustement d'une loi IPH-Gompertz de dimension 20 | Structure coxienne généralisée | Après minimisation de la somme du carré des log-ratio des fonctions de hasard") %>% 
#   hc_add_theme(mon_theme) %>% 
#   hc_tooltip(shared=T)
```

```{r}
# df <- tibble(Age=y,obs=log(quotients %>% pull("2022"))[1:(xmax+1)],aj=log(1-cdf(x10,y+1,lower.tail=FALSE)/cdf(x10,y,lower.tail=FALSE)))
# 
# highchart() %>% 
#   hc_add_series(df,"scatter",hcaes(x=Age,y=obs),name="Observé") %>% 
#   hc_add_series(df,"line",hcaes(x=Age,y=aj),name="Ajusté",marker=list(enabled=F)) %>%
#     hc_xAxis(title=list(text="Age")) %>% 
#   hc_title(text="Logarithme des quotients de mortalité") %>%
#   hc_subtitle(text="Ajustement d'une loi IPH-Gompertz de dimension 17 | Structure coxienne généralisée | Après minimisation du carré de la somme du log-ratio des fonctions de hasard") %>% 
#   hc_tooltip(shared=T)
```

```{r}
# dist_etats <- function(x,phase){
#    phase@pars$alpha %*% matrixdist:::expmat(phase@pars$S*phase@gfun$inverse(phase@gfun$pars,x))/sum(phase@pars$alpha %*% matrixdist:::expmat(phase@pars$S*phase@gfun$inverse(phase@gfun$pars,x)))
# }
# for (i in c(seq(0,110,10))){
#   df <- tibble(x=1:m,y=dist_etats(i,xchoc2)[1,])
# print(highchart() %>% 
#   hc_add_series(df,"column",hcaes(x=x,y=y)) %>% 
#     hc_title(text=paste("Distribution des états de la chaine de Markov à l'âge",i)) %>% 
#     hc_xAxis(title=list(text="Etat de la chaine")) %>% 
#     hc_legend(enabled=FALSE) %>% 
#     hc_add_theme(mon_theme) )
# }
```

## Fonction ajustement

```{r}
ajustement <- function(x,y,weight,stepsEM=1000,scale=100,maxit=1000,every=1){
  
  m <- length(x@pars$alpha)
  
  x_fit1 <- fit(x, y, weight=weight, stepsEM = stepsEM,every=every,scale=scale)
  alpha <- x_fit1@pars$alpha[1:(m-1)]
  beta <- x_fit1@gfun$pars
  S <- x_fit1@pars$S
  
  tdim <- 3*m-1
  nbeq <- 3*m
  
  if (m>1){
  A0 <- matrix(c(rep(-1,m-1),rep(0,tdim-(m-1))),nrow=1)
  A1 <- diag(-1,nrow=m-1,ncol=tdim)
  A2 <- cbind(matrix(0,nrow=m-1,ncol=m-1),diag(-1,m-1,m),diag(-1,m-1),matrix(0,nrow=m-1,ncol=1))
  A3 <- cbind(matrix(0,nrow=m,ncol=m-1),diag(-1,m),matrix(0,nrow=m,ncol=m-1),matrix(0,nrow=m,ncol=1))
  A4 <- matrix(c(rep(0,tdim-1),1),nrow=1)
  ui <- rbind(A0,-A1,A2,A3,A4)
  ci <- c(-1,rep(0,m-1),rep(0,m-1),rep(0,m),0)
  theta <- c(alpha,diag(S),ifelse(exit(S)[-m]==0,S[cbind(1:(nrow(S)-1), 2:ncol(S))]-1e-10,S[cbind(1:(nrow(S)-1), 2:ncol(S))]),beta)
  oppar <- suppressWarnings(constrOptim(theta=theta,f=loss,ui=ui,ci=ci,grad=NULL,control = list(maxit=maxit),dimension=m))}else{
    theta <- c(S,beta)
    ui <- matrix(c(-1,0,0,1),byrow = T,ncol=2)
    ci <- c(0,0)
    oppar <- suppressWarnings(constrOptim(theta=theta,f=loss,ui=ui,ci=ci,grad=NULL,control = list(maxit=maxit),dimension=m))
  }
  
  parlist <- retpar(oppar$par,m)
  
  x10 <- IPH(PH(alpha = parlist$alpha,S=parlist$S),gfun="gompertz",gfunpars = parlist$beta)

  x10@fit$obs <- y

  return(list(modele=x10,cout=oppar$value))
}
```

```{r}
m <- 4
set.seed(1)
weights <- (donnees_ajust %>% pull(dx))/100000
y <- (donnees_ajust %>% pull(Age)) + 0.5
x1 <- IPH(PH(structure = "coxienne généralisée" , dimension = m),gfun="gompertz",gfunpars = c(beta=1))
ajust <- ajustement(x1, y, weight=weights, stepsEM = 20,every=1,scale=100,maxit=5000)
```

```{r}
plot(ajust$modele,type="haz",f="log",hch=highchart() %>% hc_add_series(donnees_ajust,"scatter",hcaes(x=Age+0.5,y=log(mux)),name="Observé")) 
```

```{r}
library(parallel)

num_cores <- detectCores()


cl <- makeCluster(num_cores)

clusterExport(cl,list("y","weights","ajustement","loss","donnees_ajust","retpar"),envir = environment())
clusterEvalQ(cl,source("C:/Users/aper/Documents/PH.R"))


Ajustements <-  parLapply(cl, 1:20, function(k) {
  x1 <- IPH(PH(structure = "coxienne généralisée" , dimension = k),gfun="gompertz",gfunpars = c(beta=1))
aj <- ajustement(x1, y, weight=weights, stepsEM = 10000,every=1,scale=100)
return(aj)
})

stopCluster(cl)

```

```{r}
sapply(Ajustements,function(ajust) print(plot(ajust[[1]],type="haz",f="log",hch=highchart() %>% hc_add_series(donnees_ajust,"scatter",hcaes(x=Age+0.5,y=log(mux)),name="Observé"))) )


```

```{r}
sapply(Ajustements,function(ajust) (ajust[[2]]))
```

\

```{r}
num_cores <- detectCores()


cl <- makeCluster(num_cores)

clusterExport(cl,list("y","weights","ajustement","loss","donnees_ajust","retpar"),envir = environment())
clusterEvalQ(cl,source("C:/Users/aper/Documents/PH.R"))

# vec <- c(1,seq(10,100,10),1000,2000)
# vec <- seq(1000,5000,500)
vec <- 1:10

Ajustements2 <-  parLapply(cl,vec , function(k) {
  x1 <- IPH(PH(structure = "coxienne généralisée" , dimension = 10),gfun="gompertz",gfunpars = c(beta=1))
aj <- ajustement(x1, y, weight=weights, stepsEM = k,every=1,scale=100)
return(aj)
})

stopCluster(cl)
```

```{r}
sapply(Ajustements2,function(ajust) print(plot(ajust[[1]],type="haz",f="log",hch=highchart() %>% hc_add_series(donnees_ajust,"scatter",hcaes(x=Age+0.5,y=log(mux)),name="Observé"))) )
```

```{r}
sapply(Ajustements2,function(ajust) (ajust[[2]])) %>% plot
```

\
\
\
Tuning des hyperparamètres par algorithme génétique

```{r}

library(GA)

eval_func <- function(x) {

  m <- binary2decimal(x[1:6]) 
  stepsEM <- binary2decimal(x[7:9])
  m <- case_when(m %in% 1:20 ~ m,
                        .default = 1)
   stepsEM <- case_when(stepsEM==0 ~ 1,
                        stepsEM==1 ~ 10,
                        stepsEM==2 ~ 50,
                        stepsEM==3 ~ 100,
                        stepsEM==4 ~ 200,
                        stepsEM==5 ~ 500,
                        stepsEM==6 ~ 1000,
                        stepsEM==7 ~ 2000
                        )
  x1 <- IPH(PH(structure = "coxienne généralisée" , dimension = m),gfun="gompertz",gfunpars = c(beta=1))
  result <- ajustement(x1, y, weights, stepsEM = stepsEM,maxit=500)

  return(-result$cout)
}




result <- ga(type = "binary",nBits= 9,
             fitness = eval_func, 
  maxiter = 5, 
  popSize = 50, 
seed=1234,keepBest=TRUE)

best_params <- result$iter$bestIndv
cat("Best hyperparameters: ", best_params, "\n")

```

## Chocs

On reprend le modèle IPH coxien généralisé. On applique un choc de mortalité sur l'ensemble des états.

```{r}
xchoc <- x10
diag(xchoc@pars$S) <- (x10@pars$S %>% diag)-0.003

```

Un autre sur la moitié de la population la plus fragile.

```{r}
xchoc2 <- x10
diag(xchoc2@pars$S)[8:m] <- (x10@pars$S %>% diag)[8:m]-1
```

```{r}
df <- tibble(x=y,y1=qx(y,x10),y2=qx(y,xchoc),y3=qx(y,xchoc2))
highchart() %>% 
  hc_add_series(df,"line",hcaes(x=x,y=y1)) %>% 
  hc_add_series(df,"line",hcaes(x=x,y=y2)) %>% 
  hc_add_series(df,"line",hcaes(x=x,y=y3))
```

```{r}
df <- tibble(x=y,y1=dens(x10,y),y2=dens(xchoc,y),y3=dens(xchoc2,y))
highchart() %>% 
  hc_add_series(df,"line",hcaes(x=x,y=y1)) %>% 
  hc_add_series(df,"line",hcaes(x=x,y=y2)) %>% 
  hc_add_series(df,"line",hcaes(x=x,y=y3))
```

```{r}
integrate(function(x) dens(x10,x),0,200)
integrate(function(x) dens(xchoc,x),0,200)
integrate(function(x) dens(xchoc2,x),0,200)
```

### Régression IP

```{r}
quotients2 <- qxt %>% filter(Table=="H2021H") %>% select(-Table)
lx2 <- quotients2 %>% select(-Age) %>% apply(2,FUN =lx_rec) %>% as_tibble %>% mutate(Age=0:120,.before = "2022")
```

```{r}
dx2 <-  (lx2-lead(lx2)) %>%  mutate(Age=0:120) 
dat2 <- lx2 %>% pivot_longer(cols=c(-Age),names_to = "Annee",values_to = "lx")
dat2 <- dat2 %>% left_join(dx2 %>% pivot_longer(cols=c(-Age),names_to = "Annee",values_to = "dx"),by=c("Age","Annee"))
dat2 <- dat2 %>% mutate(Annee=as.numeric(Annee))
dat2 <- na.omit(dat2)
```

```{r}
xmax <- 110
donnees_ajust2 <- dat2 %>% filter(Annee==2022,Age<=xmax)
donnees_ajust2 <- donnees_ajust2 %>% mutate(mux=-log(1-dx/lx),Sexe="H")
donnees_ajust <- donnees_ajust %>% mutate(Sexe="F")

donnees_ajust <- donnees_ajust %>% rbind(donnees_ajust2)
```

```{r}
m <- 2
set.seed(1)
x2 <- IPH(PH(structure = "coxienne généralisée" , dimension = m),gfun="gompertz")
weights <- (donnees_ajust %>% pull(dx))/100000
y <- (donnees_ajust %>% pull(Age)) + 0.5
x2@fit <- list(weights=weights,obs=y)
set.seed(1)
covariates <- tibble(y=y,intercept=rep(1,dim(donnees_ajust)[1]),sexe=ifelse(donnees_ajust$Sexe=="F",1,0))
x_reg <- reg(x2, y ~ intercept + sexe  ,data=covariates, weight=weights, stepsEM = 1,every=1,scale=100)
```

```{r}
df <- covariates %>% mutate(weights=weights,lmux=log(donnees_ajust$mux))
X <- covariates %>% select(-y) %>% as.matrix()
plot(y[1:111],weights[1:111])
curve(dens(x_reg,x,X[1:111,]),col='red',add=T)
```

```{r}
plot(y[112:length(y)],weights[112:length(y)])
curve(dens(x_reg,x,X[112:length(y),]),col='red',add=T)
```

```{r}
plot(df$y,df$lmux,col=as.factor(df$sexe))
curve(log(haz(x_reg,x,X[1:111,])),col='red',add=T)
curve(log(haz(x_reg,x,X[112:length(y),])),col='black',add=T)
```

```{r,warning=F}
loss2 <- function(x,dimension,X){
  
  params <- tail(x,3)
  theta <- params[2:3]
  beta <- params[1]
  if (dimension==1){
    alpha <- 1
    S <- matrix(x[dimension])
  }
  else{
    alpha <- c(x[1:(dimension-1)],1-sum(x[1:(dimension-1)]))
    S <- diag(x[seq(dimension,2*dimension-1,1)])
    S[cbind(1:(nrow(S)-1), 2:ncol(S))] <- x[(2*dimension):(length(x)-3)]
    
  }
  objiph <- SPH(IPH(PH(alpha,S),gfun="gompertz",gfunpars = beta),regpars=theta)

  

  
   L <- donnees_ajust %>% group_by(Age) %>% filter(mux!= Inf) %>% summarise(A=(log(haz(objiph,Age+0.5,X))-log(mux))^2) %>% pull(A) %>%  sum
   
  cat("\r",format(Sys.time(),'%H:%M:%S'))
  cat(" Fonction de coût : ",L)
  flush.console()
  
   
  return(L)
}

alpha <- x_reg@pars$alpha[1:(m-1)]
beta <- x_reg@gfun$pars
S <- x_reg@pars$S
theta <- x_reg@reg$pars
if (m>1){
  loss2(c(alpha,diag(S),S[cbind(1:(nrow(S)-1), 2:ncol(S))],beta,theta),m,X)
}

```

```{r}
tdim <- 3*m+1
nbeq <- 3*m+2
  A0 <- matrix(c(rep(-1,m-1),rep(0,tdim-(m-1))),nrow=1)
  A1 <- diag(-1,nrow=m-1,ncol=tdim)
  A2 <- cbind(matrix(0,nrow=m-1,ncol=m-1),diag(-1,m-1,m),diag(-1,m-1),matrix(0,nrow=m-1,ncol=3))
  A3 <- cbind(matrix(0,nrow=m,ncol=m-1),diag(-1,m),matrix(0,nrow=m,ncol=m-1),matrix(0,nrow=m,ncol=3))
  A4 <- matrix(c(rep(0,tdim-3),1,0,0),nrow=1)
  ui <- rbind(A0,-A1,A2,A3,A4)
  ci <- c(-1,rep(0,m-1),rep(0,m-1),rep(0,m),0)
  parametres <- c(alpha,diag(S),ifelse(exit(S)[-m]==0,S[cbind(1:(nrow(S)-1), 2:ncol(S))]-1e-10,S[cbind(1:(nrow(S)-1), 2:ncol(S))]),beta,theta)
  oppar <- suppressWarnings(constrOptim(theta=parametres,f=loss2,ui=ui,ci=ci,grad=NULL,control = list(maxit=500),dimension=m,X=X))
```

```{r}
retpar2 <- function(x,m){
      params <- tail(x,3)
  theta <- params[2:3]
     if (m==1){
    S <- matrix(x[1])
    alpha <- 1
  }
  else{
  alpha <- x[1:(m-1)]
  alpha <- c(alpha,1-sum(alpha))
    S <- diag(x[seq(m,2*m-1,1)])
    S[cbind(1:(nrow(S)-1), 2:ncol(S))] <- x[(2*m):(length(x)-3)]
  }
    return(list(alpha=alpha,beta=beta,S=S,theta=theta))
}

parlist <- retpar2(oppar$par,m)
```

```{r}
x20 <- SPH(IPH(PH(alpha = parlist$alpha,S=parlist$S),gfun="gompertz",gfunpars = parlist$beta),regpars=parlist$theta)

x20@fit$obs <- y

plot(df$y,df$lmux,col=as.factor(df$sexe))
curve(log(haz(x20,x,X[1:111,])),col='red',add=T)
curve(log(haz(x20,x,X[112:length(y),])),col='black',add=T)  
```
